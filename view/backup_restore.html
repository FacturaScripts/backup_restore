{include="header"}

<script>
    var backup_cmd = '{$fsc->backup_comando}';
    var backup_file_now = '{$fsc->backup_file_now}';
    var chkval = true;

    function crear_backup_db() {
        $.ajax({
            type: 'POST',
            url: '{$fsc->url()}',
            async: false,
            data: 'accion=agregardb&estructura=' + chkval,
            success: function (datos) {
                alert(datos.mensaje);
                window.location.assign("{$fsc->url()}");
            },
            error: function () {
                alert("Ocurrió un error no contemplado en el plugin intentando hacer una copia de seguridad de la base de datos, por favor envíe un mensaje en el foro de soporte de FacturaScripts para verificar el problema, gracias.");
            }
        });
    }

    function crear_backup_fs() {
        $.ajax({
            type: 'POST',
            url: '{$fsc->url()}',
            async: false,
            data: 'accion=agregarfs',
            success: function (datos) {
                alert(datos.mensaje);
                window.location.assign("{$fsc->url()}");
            },
            error: function () {
                alert("Ocurrio un error no contemplado en el plugin intentando hacer una copia de seguridad de los archivos de FacturaScripts, por favor envíe un mensaje en el foro de soporte de FacturaScripts para verificar el problema, gracias.");
            }
        });
    }

    function crear_fullbackup() {
        // Backup sql
        $.ajax({
            type: 'POST',
            url: '{$fsc->url()}',
            async: false,
            data: 'accion=agregardb&estructura=' + chkval,
            error: function () {
                alert("Ocurrió un error no contemplado en el plugin intentando hacer una copia de seguridad completa (paso base de datos), por favor envíe un mensaje en el foro de soporte de FacturaScripts para verificar el problema, gracias.");
            }
        });
        // Backup archivos
        $.ajax({
            type: 'POST',
            url: '{$fsc->url()}',
            async: false,
            data: 'accion=agregarfs',
            success: function () {
                alert("Copia de seguridad de la base de datos y de archivos realizada con éxito!");
                window.location.assign("{$fsc->url()}");
            },
            error: function () {
                alert("Ocurrio un error no contemplado en el plugin intentando hacer una copia de seguridad completa (paso archivos), por favor envie un mensaje en el foro de soporte de FacturaScripts para verificar el problema, gracias.");
            }
        });
    }

    function preparar_eliminar_archivo(valor) {
        document.f_delete.delete_file.value = valor;
        document.getElementById('delete_filename').innerHTML = valor;
        $('#advertenciaEliminarArchivo').modal('show')
    }

    function c_dbStructCopy(valor) {
        chkval = valor;
    }

    $(document).ready(function () {
        $("#b_configuracion").click(function (event) {
            event.preventDefault();
            $("#modal_configuracion").modal('show');
            document.f_configuracion.backup_comando.focus();
        });

        $("#b_nuevo_backup_db").click(function (event) {
            if (backup_cmd !== '' && backup_file_now === '') {
                crear_backup_db();
            } else if (backup_cmd !== '' && backup_file_now !== '') {
                confirmacion = confirm('¿Ya hay un backup con la fecha actual, está seguro que quiere generarlo nuevamente?');
                if (confirmacion) {
                    crear_backup_db();
                }
            } else {
                alert('¡Primero debe configurar el comando para realizar el backup!');
            }
        });

        $("#b_nuevo_backup_fs").click(function (event) {
            if (backup_file_now === '') {
                crear_backup_fs();
            } else {
                confirmacion = confirm('¿Ya hay un backup con la fecha actual, está seguro que quiere generarlo nuevamente?');
                if (confirmacion) {
                    crear_backup_fs();
                }
            }
        });

        $("#b_nuevo_fullbackup").click(function (event) {
            if (backup_cmd !== '' && backup_file_now === '') {
                crear_fullbackup();
            } else if (backup_cmd !== '' && backup_file_now !== '') {
                confirmacion = confirm('¿Ya hay un backup con la fecha actual, está seguro que quiere generarlo nuevamente?');
                if (confirmacion) {
                    crear_fullbackup();
                }
            } else {
                alert('¡Primero debe configurar el comando para realizar el backup!');
            }
        });

        $("#b_eliminar_archivo").click(function (event) {
            accion_eliminar_archivo();
        });
    });
</script>

<div class="container-fluid" style="margin-top: 10px;">
    <div class="col-sm-7 col-xs-6">
        <div class="btn-group">
            <a class="btn btn-sm btn-default" href="{$fsc->url()}" title="Recargar la página">
                <span class="glyphicon glyphicon-refresh"></span>
            </a>
            <span class="btn-group">
                <a id="b_configuracion" class="btn btn-sm btn-primary" href="#">
                    <span class="fa fa-gears"></span>
                    <span class="hidden-xs">&nbsp; Configuración</span>
                </a>
                {loop="$fsc->extensions"}
                {if="$value->type=='button'"}
                <a href="index.php?page={$value->from}{$value->params}" class="btn btn-sm btn-default">{$value->text}</a>
                {/if}
                {/loop}
            </span>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#advertenciaBackupSQL">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                <span class="hidden-xs">&nbsp; Copia DB</span>
            </button>
            <a class="btn btn-sm btn-success" aria-label="Nueva copia" id="b_nuevo_backup_fs">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                <span class="hidden-xs">&nbsp; Copia FS</span>
            </a>
            <button type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#advertenciaFullBackup">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                <span class="hidden-xs">&nbsp; Copia completa</span>
            </button>
        </div>
    </div>
    <div class="col-sm-5 col-xs-6 text-right">
        <h2 style="margin-top: 0px;">
            <i class="fa fa-database" aria-hidden="true"></i> Copias de seguridad
        </h2>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Ubicación</th>
                    <th>Tamaño</th>
                    <th>Fecha</th>
                    <th class="text-center" style="min-width:125px">Acciones</th>
                </tr>
            </thead>
            {loop="$fsc->sql_backup_files"}
            <form name="f_lista_backups_sql" method="POST" action="{$fsc->url()}" class="form" role="form">
                <tr>
                    <td class="text-left">{$value->filename}</td>
                    <td class="text-left">Base de datos</td>
                    <td class="text-left">{$value->path}</td>
                    <td class="text-left">{$value->size}</td>
                    <td class="text-left">{$value->date}</td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-success btn-sm" data-toggle="modal" onclick="document.f_restaurar_backup_sql.restore_file.value = '{$value->escaped_path}'" data-target="#advertenciaRestaurarSQL" title="Restaurar DB">
                                <span class="fa fa-undo"></span>
                                <span class="hidden-xs hidden-sm">&nbsp; Restaurar DB</span>
                            </button>
                            <a href="{#FS_PATH#}{$value->path}/{$value->filename}" class="btn btn-primary btn-sm" aria-label="Descargar DB" title="Descargar DB">
                                <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span>
                                <span class="hidden-xs hidden-sm">&nbsp; Descargar DB</span>
                            </a>
                            <button type="button" onclick="preparar_eliminar_archivo('{$value->escaped_path}')" class="btn btn-danger btn-sm" title="Eliminar DB">
                                <span class="fa fa-trash" aria-hidden="true"></span>
                                <span class="hidden-xs hidden-sm">&nbsp; Eliminar DB</span>
                            </button>
                        </div>
                    </td>
                </tr>
            </form>
            {else}
            <tr  class="bg-warning">
                <td colspan="6">
                    No se ha encontrado ningún backup de base de datos de FacturaScripts.
                </td>
            </tr>
            {/loop}
            {loop="$fsc->fs_backup_files"}
            <form name="f_lista_backups_fs" method="POST" action="{$fsc->url()}" class="form" role="form">
                <tr>
                    <td class="text-left">{$value->filename}</td>
                    <td class="text-left">Archivos</td>
                    <td class="text-left">{$value->path}</td>
                    <td class="text-left">{$value->size}</td>
                    <td class="text-left">{$value->date}</td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-success btn-sm" data-toggle="modal" onclick="document.f_restaurar_backup_fs.restore_file.value = '{$value->path}'" data-target="#advertenciaRestaurarFS" title="Restaurar FS">
                                <span class="fa fa-undo"></span>
                                <span class="hidden-xs hidden-sm">&nbsp; Restaurar FS</span>
                            </button>
                            <a href="{#FS_PATH#}{$value->path}/{$value->filename}" class="btn btn-primary btn-sm" aria-label="Descargar FS" title="Descargar FS">
                                <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span>
                                <span class="hidden-xs hidden-sm">&nbsp; Descargar FS</span>
                            </a>
                            <button type="button" onclick="preparar_eliminar_archivo('{$value->escaped_path}')" class="btn btn-danger btn-sm" title="Eliminar FS">
                                <span class="fa fa-trash" aria-hidden="true"></span>
                                <span class="hidden-xs hidden-sm">&nbsp; Eliminar FS</span>
                            </button>
                        </div>
                    </td>
                </tr>
            </form>
            {else}
            <tr  class="bg-warning">
                <td colspan="6">
                    No se ha encontrado ningún backup de archivos de FacturaScripts.
                </td>
            </tr>
            {/loop}
        </table>
    </div>
</div>

<!-- Modal Configuración -->
<div class="modal fade bs-example-modal-lg" id="modal_configuracion" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form name="f_configuracion" action="{$fsc->url()}" method="post" class="form-horizontal" role="form">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title"><span class="fa fa-gears"></span>Configuración</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group col-sm-12">
                        <label for="backup_comando" class="control-label">Comando para backup:</label>
                        <input class="form-control" type="text" name="backup_comando" id="backup_comando" value="{$fsc->backup_comando}" autocomplete="off" autofocus />
                    </div>
                    <div class="col-sm-12">
                        <div class="help-block text-justify">
                            {if="$fsc->backup_comando"}
                            <div class="text-success text-center">Configuración correcta para {$fsc->db_version} {$fsc->backup_comando}</div>
                            {else}
                            <span class="text-danger">No se encuentra una herramienta para realizar copia de seguridad.</span>
                            Aquí debes configurar si no se detectó automáticamente el comando para ejecutar el backup de
                            de la base de datos, el comando suele ser mysqldump o pg_dump, pero debes colocar su ruta completa.
                            Por ejemplo:
                            <ul>
                                <li><code>/usr/src/local/mysqldump</code></li>
                                <li><code>C:\Archivos de programa\PostgreSQL\9.3\bin\pg_dump.exe</code></li>
                            </ul>
                            {/if}
                        </div>
                    </div>
                    <div class="form-group col-sm-12">
                        <label for="restore_comando" class="control-label">Comando para restore:</label>
                        <input class="form-control" type="text" name="restore_comando" id="restore_comando" value="{$fsc->restore_comando}" autocomplete="off"/>
                    </div>
                    <div class="col-sm-12">
                        <div class="help-block text-justify">
                            {if="$fsc->restore_comando"}
                            <div class="text-success text-center">Configuración correcta para {$fsc->db_version} {$fsc->restore_comando}</div>
                            {else}
                            <span class="text-danger">No se encuentra una herramienta para restaurar copia de seguridad.</span>
                            Aquí debes configurar si no se detectó automáticamente el comando para ejecutar el restore de
                            de la base de datos, el comando suele ser mysql o pg_restore, pero debes colocar su ruta completa.
                            Por ejemplo:
                            <ul>
                                <li><code>/usr/src/local/mysql</code></li>
                                <li><code>C:\Archivos de programa\PostgreSQL\9.3\bin\pg_restore.exe</code></li>
                            </ul>
                            {/if}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-primary" type="submit" name="accion" value="configuracion" onclick="this.disabled = true;
                            this.form.submit();">
                        <span class="glyphicon glyphicon-floppy-disk"></span> &nbsp; Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal FullBackup -->
<div class="modal fade bs-example-modal-lg" id="advertenciaFullBackup" tabindex="-1" role="dialog" aria-labelledby="advertenciaFullBackup">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form name="f_fullbackup" method="POST" action="{$fsc->url()}" class="form" role="form">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title text-info" id="advertenciaBackup">
                        <span class="fa fa-info"></span>
                        <span>&nbsp; Opciones del backup completo</span>
                    </h4>
                </div>
                <div class="modal-body">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Opciones avanzadas</h3>
                        </div>
                        <div class="panel-body">
                            <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                                <div class="panel panel-default">
                                    <div class="panel-heading" role="tab" id="headingOne">
                                        <h4 class="panel-title">
                                            <a role="button" class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                                Estructura y datos / Sólo datos
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
                                        <div class="panel-body">
                                            <div class="form-group">
                                                <label class="checkbox-inline" style="margin-left: 15px;">
                                                    <input type="checkbox" name="dbStructCopy" onchange="{c_dbStructCopy(this.checked)}" value="TRUE" checked=""/>
                                                    Copia estructura y datos
                                                </label>
                                            </div>
                                            <div>
                                                <ul>
                                                    <li>Activada, se copiará la base de datos y su estructura. <b>(Opción por defecto)</b></li>
                                                    <li>Desactivada, sólo se copiarán los datos.</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Añadir más opciones aquí -->
                        </div>
                        <div class="panel-footer">
                            <span class="text-info">
                                <span class="fa fa-info">&nbsp;</span>
                                <span>No es necesario cambiar ninguna opción.</span>
                            </span>
                            <br/>
                            <span class="text-danger">
                                <span class="fa fa-warning">&nbsp;</span>
                                <span><b>Sino sabes lo que implican estas opciones no las modifiques.</b></span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-sm btn-success" aria-label="Iniciar copia completa" id="b_nuevo_fullbackup">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                        <span class="hidden-xs">&nbsp; Iniciar copia completa</span>
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Backup SQL -->
<div class="modal fade bs-example-modal-lg" id="advertenciaBackupSQL" tabindex="-1" role="dialog" aria-labelledby="advertenciaBackupSQL">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form name="f_backup_sql" method="POST" action="{$fsc->url()}" class="form" role="form">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title text-info" id="advertenciaBackup">
                        <span class="fa fa-info"></span>
                        <span>&nbsp; Opciones del backup</span>
                    </h4>
                </div>
                <div class="modal-body">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Opciones avanzadas</h3>
                        </div>
                        <div class="panel-body">
                            <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                                <div class="panel panel-default">
                                    <div class="panel-heading" role="tab" id="headingOne">
                                        <h4 class="panel-title">
                                            <a role="button" class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                                Estructura y datos / Sólo datos
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
                                        <div class="panel-body">
                                            <div class="form-group">
                                                <label class="checkbox-inline" style="margin-left: 15px;">
                                                    <input type="checkbox" name="dbStructCopy" onchange="{c_dbStructCopy(this.checked)}" value="TRUE" checked=""/>
                                                    Copia estructura y datos
                                                </label>
                                            </div>
                                            <div>
                                                <ul>
                                                    <li>Activada, se copiará la base de datos y su estructura. <b>(Opción por defecto)</b></li>
                                                    <li>Desactivada, sólo se copiarán los datos.</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Añadir más opciones aquí -->
                        </div>
                        <div class="panel-footer">
                            <span class="text-info">
                                <span class="fa fa-info">&nbsp;</span>
                                <span>No es necesario cambiar ninguna opción.</span>
                            </span>
                            <br/>
                            <span class="text-danger">
                                <span class="fa fa-warning">&nbsp;</span>
                                <span><b>Sino sabes lo que implican estas opciones no las modifiques.</b></span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-sm btn-success" aria-label="Iniciar copia" id="b_nuevo_backup_db">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                        <span class="hidden-xs">&nbsp; Iniciar copia</span>
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Restaurar SQL -->
<div class="modal fade bs-example-modal-lg" id="advertenciaRestaurarSQL" tabindex="-1" role="dialog" aria-labelledby="advertenciaRestaurarSQL">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form name="f_restaurar_backup_sql" method="POST" action="{$fsc->url()}" class="form" role="form">
                <div class="modal-header">
                    <button type="button" class="close" onclick="document.f_restaurar_backup_sql.restore_file.value = ''" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title text-danger" id="advertenciaRestaurar">
                        <span class="fa fa-warning"></span>
                        <span>&nbsp; Advertencia</span>
                    </h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="restore_file" value="">
                    Está seguro que quiere utilizar este backup de base de datos de FacturaScripts para restaurar?<br /><br />
                    Haciendo esto se eliminará cualquier información que se haya generado después de que se creó este backup de base de datos.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="document.f_restaurar_backup_sql.restore_file.value = ''">Cerrar</button>
                    <button type="submit" name="accion" value="restaurardb" class="btn btn-danger">Restaurar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Restaurar FS -->
<div class="modal fade bs-example-modal-lg" id="advertenciaRestaurarFS" tabindex="-1" role="dialog" aria-labelledby="advertenciaRestaurarFS">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form name="f_restaurar_backup_fs" method="POST" action="{$fsc->url()}" class="form" role="form">
                <div class="modal-header">
                    <button type="button" class="close" onclick="document.f_restaurar_backup_fs.restore_file.value = ''" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title text-danger" id="advertenciaRestaurar">
                        <span class="fa fa-warning"></span>
                        <span>&nbsp; Advertencia</span>
                    </h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="restore_file" value="">
                    Está seguro que quiere utilizar este backup de archivos de FacturaScripts para restaurar?<br /><br />
                    Haciendo esto se eliminará cualquier información que se haya generado después de que se creó este backup de archivos.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="document.f_restaurar_backup_fs.restore_file.value = ''">Cerrar</button>
                    <a class="btn btn-sm btn-success" aria-label="Nueva copia" id="b_nuevo_backup_db">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                        <span class="hidden-xs">&nbsp; Copia DB</span>
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar Archivo -->
<div class="modal fade bs-example-modal-lg" id="advertenciaEliminarArchivo" tabindex="-1" role="dialog" aria-labelledby="advertenciaEliminarArchivo">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form name="f_delete" method="POST" action="{$fsc->url()}" class="form" role="form">
                <div class="modal-header">
                    <button type="button" class="close" onclick="document.f_delete.delete_file.value = ''" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title text-danger" id="advertenciaEliminar">
                        <span class="fa fa-warning"></span>
                        <span>&nbsp; Advertencia</span>
                    </h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="delete_file" id="delete_file" value="">
                    Está seguro que quiere eliminar el archivo <span class="text-info" id="delete_filename"></span>?<br /><br />
                    No será posible recuperar el archivo después de su eliminación.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="document.f_delete.delete_file.value = ''">Cerrar</button>
                    <button type="submit" name="accion" value="eliminar" class="btn btn-danger">
                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                        <span class="hidden-xs">&nbsp; Eliminar</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{include="footer"}
